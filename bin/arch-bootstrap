#!/usr/bin/perl

=pod

=head1 NAME

arch-bootstrap - bootstrap archlinux from mirror

=head1 SYNOPSIS

arch-bootstrap [arch] [mirror] [dir] [packages]
CUSTOM_ARCH_REPO=1 CORE_NAME=arch_repo arch-bootstrap [arch] [repo] [dir] [packages]

=head1 EXAMPLES

arch-bootstrap x86_64 https://mirrors.evowise.com/archlinux /mnt base-devel mc htop"
CUSTOM_ARCH_REPO=1 CORE_NAME=arch_repo arch-bootstrap x86_64 http://mirror.site/arch_repo /mnt base-devel mc htop"

=cut

use warnings;
use strict;

if ($> != 0) {
    die "You are not root!";
}

if (@ARGV < 4) {
    die "Not enough arguments!";
}
my ($arch, $mirror, $dir) = @ARGV;
my @packages;
if (@ARGV > 5) {
    for (4..$#ARGV) {
        push(@packages, $ARGV[$_]);
    }
}

exec 'mkdir', '-m', '0755', '-p', $dir.'/var/lib/pacman/sync', $dir.'/log', $dir.'/dev', $dir.'/run', $dir.'/etc/pacman.d';

if (defined $ENV{CUSTOM_ARCH_REPO} && $ENV{CUSTOM_ARCH_REPO} == 1) {
    my $core_name=$ENV{CORE_NAME};
}
else {
    my $core_name='core';
    if (exec 'wget', '--spider', $mirror.'/'.$core_name.'/os/'.$arch.'/'.$core_name.'.db') {
        exec 'wget', '-O', $dir.'/var/lib/pacman/sync'.$core_name.'db', $mirror.'/'.$core_name.'/os/'.$arch.'/'.$core_name.'.db';
        my $repo_file=$dir.'/var/lib/pacman/sync'.$core_name.'db';
    }
    elsif (exec 'wget', '--spider', $mirror.'/'.$core_name.'/'.$core_name.'/'.$arch.'.db') {
        my $repo_file=$dir.'/var/lib/pacman/sync'.$core_name.'db';
    }
    else {
        die "Could not download core repo file.";
    }
}
