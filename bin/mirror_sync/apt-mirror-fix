#!/bin/bash

# Check avaliable files by SHA256 sums. Corrupted files will be redownloaded. Requries mirror.list file, wget, md5sum, sha256sum, bash, coreutils.
if [[ ! -f $1 ]]; then
  echo "Check and fix script after apt-mirror. Requries path to config."
  echo "Example: $0 /etc/apt/mirror.list"
  exit 1
fi

mirror_path=$(grep -F "set base_path" "$1" | tr -s " " | cut -d' ' -f3)
declare -gx mirror_path
file_hashes="$mirror_path/var/SHA256"
count=$(< "$file_hashes" wc -l)
declare -gx count
echo "Checking files..."
echo "X - Signature is incorrect. Redownloading."
echo "E - File not found. Skipping."
echo "N - Checked. Hashsum is correct."
echo "Files to check: $count"
rm -rf "$mirror_path/mirror/download_X.sh" "$mirror_path/mirror/download_E.sh"

deb_check_file() {
  IFS=" " read -r -a file_sum <<< "$*"
  sum="${file_sum[0]}"
  file="${file_sum[1]}"
  if [[ -f $mirror_path/mirror/$file ]]; then
    case ${#sum} in
      64) echo "$sum $mirror_path/mirror/$file" | sha256sum -c - &>> /dev/null
      ;;
      32) echo "$sum $mirror_path/mirror/$file" | md5sum -c - &>> /dev/null;
      ;;
      *) echo "!"
      ;;
    esac
    exit_code="$?"
    if [[ $exit_code == "0" ]]; then
      echo -n 'N'
    else
      echo -n 'X'
      echo -e "rm -rf \"$mirror_path/mirror/$file\"\nwget -t 3 -O $mirror_path/mirror/$file https://$file" >> "$mirror_path/mirror/download_X.sh"
    fi
  else
   echo -n 'E'
   echo -e "wget -t 3 -O $mirror_path/mirror/$file https://$file" >> "$mirror_path/mirror/download_E.sh"
  fi
}
export -f deb_check_file

sp="|\-/"; s=1
E_f=0; X_f=0;
while IFS= read -r -n1 char; do
 [[ $char == "X" ]] && X_f=$((X_f+1))
 [[ $char == "E" ]] && E_f=$((E_f+1))
 [[ $char == "N" ]] && N_f=$((N_f+1))
 [[ $char == "!" ]] && echo "Someting went wrong!"
 echo -ne "\e[2KProgress:$((count-N_f))[${sp:(i++)*s%${#sp}:s}]:$3; X:$((X_f)); E:$((E_f)); N:$((N_f)).\r"
done < <(< "$file_hashes" xargs -I {} -n 1 -P $(($(nproc)*1024)) bash -c 'deb_check_file "$@"' _ {})
echo -e "\nComplete! Have a nice day!"
