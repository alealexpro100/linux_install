#!/bin/bash
###############################################################
### voidlinux boostrap script 0.2.1
### Copyright (C) 2020 ALEXPRO100 (ktifhfl)
### License: GPL v3.0
###############################################################

set -e

#Use library
if [[ -z $ALEXPRO100_LIB_VERSION ]]; then
  if [[ -z $ALEXPRO100_LIB_LOCATION ]]; then
    if [[ -f ${BASH_SOURCE[0]%/*}/alexpro100_lib.sh ]]; then
      ALEXPRO100_LIB_LOCATION="${BASH_SOURCE[0]%/*}/alexpro100_lib.sh"
      echo "Using $ALEXPRO100_LIB_LOCATION."
    else
      echo -e "ALEXPRO100_LIB_LOCATION is not set!"; return 1
    fi
  fi
  source $ALEXPRO100_LIB_LOCATION
fi

# Check options.
if [[ -z $4 ]]; then
  echo "Void linux boostrap script. It uses only choosed mirror."
  echo "Example: $0 x86_64 musl https://alpha.de.repo.voidlinux.org/current /mnt htop"
  exit 1
fi

arch=$1 version=$2 mirror=$3 dir=$(realpath -q $4); shift 4; add_packages="$@"
parse_arch $(uname -m)
if [[ "$void_arch" == "aarch64" ]]; then
  repo_xbps="$mirror/$void_arch/"
else
  repo_xbps="$mirror/musl/"
fi
if [[ "$arch" == "aarch64" ]]; then
  mirror="$mirror/$arch"
  [[ "$version" == "musl" ]] && arch="$arch-musl"
elif [[ "$version" == "musl" ]]; then
  arch="$arch-musl"; mirror="$mirror/musl"
fi

check_url "$mirror/$arch-repodata" || return_err "Incorrect arch $arch, version $version or mirror $mirror!"
check_url "$repo_xbps/$void_arch-musl-repodata" || return_err "Check $repo_xbps/$void_arch-musl-repodata!"

#if [[ ! $arch == $void_arch ]]; then
#  if [[ ! -f /usr/bin/qemu-$qemu_arch-static ]]; then
#    return_err "No /usr/bin/qemu-$qemu_arch-static! Please install qemu-static."
#  fi
#fi

#Find, download and unpack database, certificate and xbps-static and install system with it.
create_tmp_dir xbps_tmp
echo "Getting repodata to download xbps-static for $void_arch..."
get_file_s "$xbps_tmp/repodata" "$repo_xbps/$void_arch-musl-repodata" 
tar --zstd -xf "$xbps_tmp/repodata" -C "$xbps_tmp"
xbps_name=$(cat $xbps_tmp/index.plist | grep xbps-static- | sed -e 's/<string>//;s/<\/string>//;s/\t\t//')
echo "Downloading and extracting xbps-static..."
get_file_s "$xbps_tmp/xbps-static.xbps" "$repo_xbps/$xbps_name.$void_arch-musl.xbps" 
tar --zstd -xf "$xbps_tmp/xbps-static.xbps" -C $xbps_tmp
echo "Installing base..."
yes | XBPS_ARCH=$arch SSL_NO_VERIFY_PEER=1 $xbps_tmp/usr/bin/xbps-install.static -r $dir -R $mirror -A -Suy base-voidstrap $add_packages
echo "#repository=$mirror" >> $dir/etc/xbps.d/install_repo.conf
rm -rf "$xbps_tmp"

echo "Void linux was succesfully installed to $dir."

# =)
echo "Script succesfully ended its work. Have a nice day!"
